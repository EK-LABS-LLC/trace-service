services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: pulse
      POSTGRES_PASSWORD: pulse
      POSTGRES_DB: pulse
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pulse -d pulse"]
      interval: 5s
      timeout: 5s
      retries: 5

  nats:
    build:
      context: ./.config/nats
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - ./.config/nats/.config/nats-server.conf:/etc/nats/nats-server.conf:ro
      - ./.config/nats/.config/streams:/etc/nats/streams:ro
      - ./.config/nats/.config/consumers:/etc/nats/consumers:ro
      - ./.config/nats/start-nats.sh:/etc/nats/start-nats.sh:ro
    environment:
      NATS_CONFIG: /etc/nats/nats-server.conf
      NATS_URL: nats://127.0.0.1:4222
      JETSTREAM_HEALTH: http://127.0.0.1:8222/healthz
      STREAM_NAME: TRACE_STREAM
      STREAM_CONFIG: /etc/nats/streams/trace-stream.json
      CONSUMER_NAME: trace-stream-consumer
      CONSUMER_CONFIG: /etc/nats/consumers/trace-stream-consumer.json
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8222/healthz >/dev/null"]
      interval: 5s
      timeout: 5s
      retries: 10

  trace-service:
    build:
      context: ..
      dockerfile: trace-service/Dockerfile
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgres://pulse:pulse@postgres:5432/pulse
      NATS_URL: nats://nats:4222
      PORT: 3000
      NODE_ENV: development
      ADMIN_KEY: dev-admin-key
      BETTER_AUTH_SECRET: dev-secret-key-at-least-32-characters-long-for-signing
      BETTER_AUTH_URL: http://localhost:3000
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy

volumes:
  postgres_data:
