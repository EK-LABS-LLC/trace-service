name: CI

on:
  push:
    branches:
      - main
      - dual-mode
  pull_request:

jobs:
  single-mode:
    runs-on: ubuntu-latest
    env:
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      BETTER_AUTH_URL: http://localhost:3000
      FRONTEND_URL: http://localhost:5173
      NODE_ENV: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install

      - name: Run single mode e2e tests
        run: make test-e2e

  scale-mode:
    runs-on: ubuntu-latest
    env:
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      BETTER_AUTH_URL: http://localhost:3000
      FRONTEND_URL: http://localhost:5173
      NODE_ENV: test
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: pulse
          POSTGRES_PASSWORD: pulse
          POSTGRES_DB: pulse
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U pulse -d pulse"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install

      - name: Run scale mode e2e tests
        env:
          PULSE_MODE: scale
          DATABASE_URL: postgresql://pulse:pulse@localhost:5432/pulse
          WAL_DIR: .data/wal.test
          WAL_SPAN_DIR: .data/wal-spans.test
          TRACE_WAL_PARTITIONS: "1"
          SPAN_WAL_PARTITIONS: "1"
        run: |
          set -e
          bun run db:migrate:scale
          rm -rf .data/wal.test .data/wal-spans.test
          bun run pulse-scale.ts > /tmp/trace-service-scale-test.log 2>&1 &
          PID=$!
          trap 'kill $PID 2>/dev/null || true; wait $PID 2>/dev/null || true' EXIT
          for i in $(seq 1 40); do
            if curl -fsS http://localhost:3000/health >/dev/null 2>&1; then
              break
            fi
            sleep 0.5
            if [ "$i" -eq 40 ]; then
              echo "Service failed to become healthy. Last logs:"
              tail -n 200 /tmp/trace-service-scale-test.log || true
              exit 1
            fi
          done
          bun test --env-file=.env.test

  release-artifacts:
    runs-on: ubuntu-latest
    needs:
      - single-mode
      - scale-mode
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install

      - name: Build dual artifacts and checksums
        run: bun run release:artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pulse-binaries
          path: |
            dist/pulse
            dist/pulse-scale
            dist/checksums.txt
